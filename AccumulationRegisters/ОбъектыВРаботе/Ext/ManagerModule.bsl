
Процедура ПринятьУбратьВРаботу(Автор) Экспорт
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ
	                      |	Пользователи.Ссылка,
	                      |	Пользователи.Подразделение,
	                      |	Пользователи.Организация
	                      |ИЗ
	                      |	Справочник.Пользователи КАК Пользователи
	                      |ГДЕ
	                      |	НЕ Пользователи.ЭтоГруппа");
	Сотрудник = Запрос.Выполнить().Выбрать();
	Пока Сотрудник.Следующий() Цикл
		//Принять в работу
		Запрос = Новый Запрос("ВЫБРАТЬ
		                      |	ВЫБОР ТИПЗНАЧЕНИЯ(Мероприятие.Объект)
		                      |		КОГДА ТИП(Справочник.ИсполнительныеДокументы)
		                      |			ТОГДА Мероприятие.Объект.Владелец
		                      |		ИНАЧЕ Мероприятие.Объект
		                      |	КОНЕЦ КАК Объект
		                      |ПОМЕСТИТЬ ТаблицаМ
		                      |ИЗ
		                      |	Задача.Мероприятие КАК Мероприятие
		                      |ГДЕ
		                      |	Мероприятие.Ответственный = &Ответственный
		                      |	И (НЕ Мероприятие.Выполнена)
		                      |	И (НЕ Мероприятие.ПометкаУдаления)
		                      |;
		                      |
		                      |////////////////////////////////////////////////////////////////////////////////
		                      |ВЫБРАТЬ
		                      |	ДОВРаботеОстаткиОрг.Объект
		                      |ИЗ
		                      |	РегистрНакопления.ОбъектыВРаботе.Остатки(
		                      |			,
		                      |			Подразделение = ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка)
		                      |				И Сотрудник = ЗНАЧЕНИЕ(Справочник.Пользователи.ПустаяСсылка)) КАК ДОВРаботеОстаткиОрг
		                      |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ОбъектыВРаботе.Остатки(, Сотрудник = &Ответственный) КАК ДОВРаботеОстаткиСотр
		                      |		ПО (ДОВРаботеОстаткиСотр.Объект = ДОВРаботеОстаткиОрг.Объект)
		                      |		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаМ КАК ТаблицаМ
		                      |		ПО (ТаблицаМ.Объект = ДОВРаботеОстаткиОрг.Объект)
		                      |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ОтветственныеСотрудники КАК ОтветственныеСотрудники
		                      |		ПО (ОтветственныеСотрудники.Объект = ДОВРаботеОстаткиОрг.Объект)
		                      |			И (ОтветственныеСотрудники.Пользователь = &Ответственный)
		                      |ГДЕ
		                      |	ДОВРаботеОстаткиСотр.Объект ЕСТЬ NULL 
		                      |	И ((НЕ ТаблицаМ.Объект ЕСТЬ NULL )
		                      |			ИЛИ (НЕ ОтветственныеСотрудники.Объект ЕСТЬ NULL ))
		                      |
		                      |СГРУППИРОВАТЬ ПО
		                      |	ДОВРаботеОстаткиОрг.Объект
		                      |;
		                      |
		                      |////////////////////////////////////////////////////////////////////////////////
		                      |ВЫБРАТЬ
		                      |	ДОВРаботеОстаткиСотр.Объект
		                      |ИЗ
		                      |	РегистрНакопления.ОбъектыВРаботе.Остатки(, Сотрудник = &Ответственный) КАК ДОВРаботеОстаткиСотр
		                      |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ОтветственныеСотрудники КАК ОтветственныеСотрудники
		                      |		ПО (ОтветственныеСотрудники.Пользователь = &Ответственный)
		                      |			И (ОтветственныеСотрудники.Объект = ДОВРаботеОстаткиСотр.Объект)
		                      |		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаМ КАК ТаблицаМ
		                      |		ПО (ТаблицаМ.Объект = ДОВРаботеОстаткиСотр.Объект)
		                      |ГДЕ
		                      |	ТаблицаМ.Объект ЕСТЬ NULL 
		                      |	И ОтветственныеСотрудники.Объект ЕСТЬ NULL 
		                      |
		                      |СГРУППИРОВАТЬ ПО
		                      |	ДОВРаботеОстаткиСотр.Объект
		                      |;
		                      |
		                      |////////////////////////////////////////////////////////////////////////////////
		                      |УНИЧТОЖИТЬ ТаблицаМ");
		Запрос.УстановитьПараметр("Ответственный", Сотрудник.Ссылка);
		Результат = Запрос.ВыполнитьПакет();
		Если Не Результат[1].Пустой() Тогда
			ДокОбъект = Документы.АктПередачи.СоздатьДокумент();
			ДокОбъект.Дата = ТекущаяДата();
			ДокОбъект.Автор = Автор;
			ДокОбъект.Организация = Сотрудник.Организация;
			ДокОбъект.ПодразделениеПринимающее = Сотрудник.Подразделение;
			ДокОбъект.СотрудникПринимающий = Сотрудник.Ссылка;
			ДокОбъект.Объекты.Загрузить(Результат[1].Выгрузить());
			Попытка
				ДокОбъект.Записать(РежимЗаписиДокумента.Проведение);
			Исключение
				Сообщить(ОписаниеОшибки());
			КонецПопытки;
		КонецЕсли;
		
		//Убрать из работы
		Если Не Результат[2].Пустой() Тогда
			ДокОбъект = Документы.АктПередачи.СоздатьДокумент();
			ДокОбъект.Дата = ТекущаяДата();
			ДокОбъект.Автор = Автор;
			ДокОбъект.Организация = Сотрудник.Организация;
			ДокОбъект.ПодразделениеПередающее = Сотрудник.Подразделение;
			ДокОбъект.СотрудникПередающий = Сотрудник.Ссылка;
			ДокОбъект.Объекты.Загрузить(Результат[2].Выгрузить());
			Попытка
				ДокОбъект.Записать(РежимЗаписиДокумента.Проведение);
			Исключение
				Сообщить(ОписаниеОшибки());
			КонецПопытки;
		КонецЕсли;
	КонецЦикла;
	
	//
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ
						  |	ПодразделенияОрганизаций.Ссылка,
						  |	ПодразделенияОрганизаций.Владелец
						  |ИЗ
						  |	Справочник.ПодразделенияОрганизаций КАК ПодразделенияОрганизаций");
	Подразделение = Запрос.Выполнить().Выбрать();
	Пока Подразделение.Следующий() Цикл
		//Принять в работу
		Запрос = Новый Запрос("ВЫБРАТЬ
		                      |	ДОВРаботеОстаткиСотр.Объект
		                      |ИЗ
		                      |	РегистрНакопления.ОбъектыВРаботе.Остатки(, Подразделение = &Подразделение) КАК ДОВРаботеОстаткиСотр
		                      |
		                      |СГРУППИРОВАТЬ ПО
		                      |	ДОВРаботеОстаткиСотр.Объект
		                      |
		                      |ИМЕЮЩИЕ
		                      |	СУММА(ДОВРаботеОстаткиСотр.КоличествоОстаток) = 1");
		Запрос.УстановитьПараметр("Подразделение", Подразделение.Ссылка);
		Результат = Запрос.Выполнить();					  
		//Убрать из работы
		Если Не Результат.Пустой() Тогда
			ДокОбъект = Документы.АктПередачи.СоздатьДокумент();
			ДокОбъект.Дата = ТекущаяДата();
			ДокОбъект.Автор = Автор;
			ДокОбъект.Организация = Подразделение.Владелец;
			ДокОбъект.ПодразделениеПередающее = Подразделение.Ссылка;
			//ДокОбъект.СотрудникПередающий = Сотрудник.Ссылка;
			ДокОбъект.Объекты.Загрузить(Результат.Выгрузить());
			Попытка
				ДокОбъект.Записать(РежимЗаписиДокумента.Проведение);
			Исключение
				Сообщить(ОписаниеОшибки());
			КонецПопытки;
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры
