

&НаСервере
Процедура РассчитатьГрафикНаСервере()
	Объект.РезультатДниПросрочки = 0;
	Объект.РезультатОсновнойДолг = 0;
	Объект.РезультатПроценты = 0;
	Объект.РезультатПросроченныеПроценты = 0;
	Объект.РезультатШтрафы = 0;
	Объект.РезультатПени = 0;
	Объект.РезультатКУплате = 0;
		
	ЗначениеОбъект = РеквизитФормыВЗначение("Объект");
	ЗначениеОбъект.ЗагрузитьГрафикНачислений();
	ЗначениеВРеквизитФормы(ЗначениеОбъект, "Объект");
	
	к = Объект.ГрафикНачисленияИПогашения.Количество();
	Если к > 0 Тогда
		стр = Объект.ГрафикНачисленияИПогашения[к-1];
		Объект.РезультатДниПросрочки = стр.ДниПросрочки;
		Объект.РезультатКУплате = стр.КУплате;
		Объект.РезультатОсновнойДолг = стр.ОстаткиОсновнойДолг;
		Объект.РезультатПроценты = стр.ОстаткиПроценты;
		Объект.РезультатПросроченныеПроценты = стр.ОстаткиПросроченныеПроценты;
		Объект.РезультатШтрафы = стр.ОстаткиШтрафы;
		Объект.РезультатПени = стр.ОстаткиПени;
	КонецЕсли;
	
	
КонецПроцедуры

&НаКлиенте
Процедура РассчитатьГрафик(Команда)
	РассчитатьГрафикНаСервере();
КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	Объект.ДатаВыдачиЗайма = ТекущаяДатаСеанса();
	Объект.ДатаДоговора = ТекущаяДатаСеанса();
	Объект.ДатаПогашения = ТекущаяДатаСеанса() + 10 * 24 * 3600;
	Объект.ДатаРасчета = ТекущаяДатаСеанса() + 20 * 24 * 3600;
	Объект.СуммаВыданногоЗайма = 10000;
	Объект.ПроцентнаяСтавка = 1;

	УправлениеФормой();
КонецПроцедуры

&НаСервере
Процедура УправлениеФормой()
	Элементы.СпособПогашения.ТолькоПросмотр = (Объект.ВидПлатежа = Перечисления.ВидыПлатежей.Аннуитетный) ИЛИ (Объект.ВидПлатежа = Перечисления.ВидыПлатежей.Индивидуальный);	
	Элементы.ВидПроцентнойСтавки.ТолькоПросмотр = Истина;
	Элементы.ДатаПогашенияЗадолженности.ТолькоПросмотр = Истина;
	Элементы.ПериодичностьСрокаЗайма.ТолькоПросмотр = (Объект.ВидПлатежа = Перечисления.ВидыПлатежей.Индивидуальный);	
КонецПроцедуры

&НаСервере
Процедура ЗаймПриИзмененииНаСервере()
	//Объект.ДатаВыдачиЗайма = ОбъектыСервер.ПолучитьЗначениеСвойства(Объект.Займ,"0046     ");
	//Объект.ДатаДоговора = ОбъектыСервер.ПолучитьЗначениеСвойства(Объект.Займ,"0046     ");
	//Объект.ДатаПогашения = ОбъектыСервер.ПолучитьЗначениеСвойства(Объект.Займ,"0047     ");
	//Объект.ДатаРасчета = ТекущаяДата();
	//Объект.СуммаВыданногоЗайма = ОбъектыСервер.ПолучитьЗначениеСвойства(Объект.Займ,"0048     ");
	//Объект.ПроцентнаяСтавка = ОбъектыСервер.ПолучитьЗначениеСвойства(Объект.Займ,"0045     ");
	//
	//Объект.ОстаткиДата = ОбъектыСервер.ПолучитьЗначениеСвойства(Объект.Займ,"0043     ");
	//Объект.ДниПросрочки = ОбъектыСервер.ПолучитьЗначениеСвойства(Объект.Займ,"0069     ");
	//ЗаполнитьОстатки(Объект.Займ);

	// Вставить содержимое обработчика.
	
	ЗначениеОбъект = РеквизитФормыВЗначение("Объект");
	ЗначениеОбъект.ЗаполнитьДанные();
	ЗначениеВРеквизитФормы(ЗначениеОбъект, "Объект");
	УправлениеФормой();
КонецПроцедуры

&НаКлиенте
Процедура ЗаймПриИзменении(Элемент)
	ЗаймПриИзмененииНаСервере();
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьОстатки(ДО)
	Запрос = Новый Запрос();
	Запрос.Текст = "ВЫБРАТЬ
	               |	ЗадолженностьПоОбъектамОстатки.ОсновнойДолгДООстаток КАК ОсновнойДолгДООстаток,
	               |	ЗадолженностьПоОбъектамОстатки.ПроцентыДООстаток КАК ПроцентыДООстаток,
	               |	ЗадолженностьПоОбъектамОстатки.ШтрафыДООстаток КАК ШтрафыДООстаток
	               |ИЗ
	               |	РегистрНакопления.ЗадолженностьПоОбъектам.Остатки(, (ВЫРАЗИТЬ(Объект КАК Справочник.ДолговыеОбязательства)) = &Объект) КАК ЗадолженностьПоОбъектамОстатки";
	Запрос.УстановитьПараметр("Объект",ДО);
	Рез = Запрос.Выполнить().Выбрать();
	Пока Рез.Следующий() Цикл
		Объект.ОстаткиОД = Рез.ОсновнойДолгДООстаток;
		Объект.ОстаткиПросроченныеПроценты = Рез.ШтрафыДООстаток;
		Объект.ОстаткиПроценты = Рез.ПроцентыДООстаток;
	КонецЦикла;	
	
КонецПроцедуры


&НаСервере
Процедура ПриОткрытииНаСервере()
	Объект.ДатаРасчета = НачалоДня(ТекущаяДатаСеанса());
	Объект.ТекущийДоговор = РасчетЗадолженностиМФО.ПолучитьТекущийДоговор(Объект.Займ, НачалоДня(ТекущаяДатаСеанса()));
	Список = РасчетЗадолженностиМФО.СписокРеквизитовДоговорМикрозайма();
	Для Каждого Реквизит Из Список Цикл
		Попытка
			Объект[Реквизит] = Объект.ТекущийДоговор[Реквизит];
		Исключение
			
		КонецПопытки;
	КонецЦикла;
	Объект.ИсторияПлатежей.Загрузить(РасчетЗадолженностиМФО.ПолучитьИсториюПлатежей(Объект.ТекущийДоговор));
	
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	ПриОткрытииНаСервере();
КонецПроцедуры
	
	

