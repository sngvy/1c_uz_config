////////////////////////////////////////////////////////////////////////////////
// Обработчики команд

&НаКлиенте
Процедура ЗаписатьВыполнить()
	
	ОчиститьСообщения();
	
	Если Объект.УстановитьБлокировкуСоединений Тогда
		
		// проверки возможности установки блокировки
		Если ЗначениеЗаполнено(Объект.ОкончаниеБлокировки) И Объект.НачалоБлокировки > Объект.ОкончаниеБлокировки Тогда
			УдалитьОбщегоНазначенияКлиентСервер.СообщитьПользователю(НСтр("ru = 'Дата окончания блокировки не может быть меньше даты начала блокировки. Блокировка не установлена.'"));
			Возврат;
		КонецЕсли;
		
		Попытка
			ПроверитьПредусловияБлокировки();
		Исключение
			УдалитьОбщегоНазначенияКлиентСервер.СообщитьПользователю(ИнформацияОбОшибке().Описание);
			Возврат;
		КонецПопытки;
		
		ТекстВопроса = НСтр("ru = 'После установки блокировки в информационной базе будет запущен
		                          |режим завершения работы всех пользователей (включая Вас)
		                          |на период действия блокировки.
		                          |Вы действительно хотите установить блокировку?'");
		
		ЗаголовокВопроса = НСтр("ru = 'Установка блокировки соединений с информационной базой'");
		
		Ответ = Вопрос(ТекстВопроса, РежимДиалогаВопрос.ДаНетОтмена, 60, КодВозвратаДиалога.Нет,
		               ЗаголовокВопроса);
		
		Если Ответ <> КодВозвратаДиалога.Да Тогда
			Возврат;
		КонецЕсли;
		
	КонецЕсли;
	
	УстановитьСнятьБлокировку();
	
	СоединенияИБКлиент.УстановитьОбработчикиОжиданияЗавершенияРаботыПользователей(
		Объект.УстановитьБлокировкуСоединений);
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// Вспомогательные процедуры

&НаСервере
Процедура УстановитьСнятьБлокировку()
	
	РеквизитФормыВЗначение("Объект").ВыполнитьУстановку();
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ ФОРМЫ

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Если УдалитьОбщегоНазначения.ИнформационнаяБазаФайловая() Тогда
		Элементы.ПараметрыАдминистрированияИнформационнойБазы.Видимость = Ложь;
	КонецЕсли;
	
	Обработка = РеквизитФормыВЗначение("Объект");
	Обработка.ПолучитьПараметрыБлокировки();
	
	ЗначениеВРеквизитФормы(Обработка, "Объект");
	
КонецПроцедуры

&НаКлиенте
Процедура АктивныеПользователи(Команда)
	
	ОткрытьФорму("Обработка.АктивныеПользователи.Форма",,ЭтаФорма);
	
КонецПроцедуры

&НаСервереБезКонтекста
Процедура ПроверитьПредусловияБлокировки() Экспорт
	
	Если УдалитьОбщегоНазначения.ИнформационнаяБазаФайловая() Тогда
		НазванияСоединенийИБ = "";
		Если НЕ АктивныТолькоКлиентскиеПриложения(НазванияСоединенийИБ) Тогда
			ТекстСообщения = УдалитьСтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Существуют активные соединения, которые невозможно завершить. Блокировка не установлена.
					|%1'"), 
				НазванияСоединенийИБ);
			ВызватьИсключение ТекстСообщения;
		КонецЕсли;
	КонецЕсли;

КонецПроцедуры

&НаСервереБезКонтекста
Функция АктивныТолькоКлиентскиеПриложения(НазванияСоединенийИБ)
	
	Результат = Истина;
	НазванияСоединенийИБ = "";
	Для каждого Соединение Из ПолучитьСоединенияИнформационнойБазы() Цикл
		Если Соединение.НомерСоединения = НомерСоединенияИнформационнойБазы() Тогда
			Продолжить;
		КонецЕсли;
		Если Соединение.ИмяПриложения <> "1CV8" И Соединение.ИмяПриложения <> "1CV8C" И
			Соединение.ИмяПриложения <> "WebClient" Тогда
			НазванияСоединенийИБ = НазванияСоединенийИБ + Символы.ПС + " - " + Соединение;
			Результат = Ложь;
		КонецЕсли;
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции

&НаКлиенте
Процедура ПараметрыАдминистрированияИнформационнойБазы(Команда)
	
	ОткрытьФорму("Обработка.БлокировкаСоединенийСИнформационнойБазой.Форма.ПараметрыАдминистрированияСервернойИБ");
	
КонецПроцедуры
